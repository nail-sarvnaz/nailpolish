<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>رزرو نوبت ناخن — Nail_Sarvnaz</title>

<!-- فونت وزیر -->
<link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003.04/fonts/font-face.css" rel="stylesheet">

<style>
body{margin:0;font-family:"Vazirmatn",sans-serif;background:#000 url('logo-bg.png') no-repeat center center fixed;background-size:cover;color:#111;}
.overlay{min-height:100vh;background:rgba(0,0,0,0.45);display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box;}
.panel{max-width:620px;width:100%;background:rgba(255,255,255,0.95);border-radius:12px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,0.18);}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.brand{display:flex;align-items:center;gap:12px;}
.logo-mark{width:50px;height:50px;border-radius:50%;display:grid;place-items:center;color:#ff9eb5;font-weight:900;}
h1{font-size:20px;margin:0;color:#c2185b;}
p.lead{font-size:14px;color:#666;margin:6px 0 0;}
form{display:grid;gap:10px;margin-top:6px;}
label{font-weight:700;font-size:13px;color:#333;}
input, select{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e6e6;font-size:15px;background:#fff;}
.row{display:flex;gap:10px;}
.row .col{flex:1;}
.price-box{margin-top:6px;background:linear-gradient(90deg,#ff9eb5,#e07090);color:#fff;padding:12px;border-radius:10px;text-align:center;font-weight:800;}
.times{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;justify-content:center;}
.slot{padding:11px 16px;border-radius:999px;border:1px solid #ff9eb5;background:#fff;cursor:pointer;font-weight:700;transition:all .18s ease;min-width:96px;text-align:center;}
.slot:hover{background:#fff0f6;transform:translateY(-3px);}
.slot.taken{background:#f2f2f2;color:#999;border-color:#ddd;cursor:not-allowed;transform:none;}
.slot.selected{background:#ff9eb5;color:#fff;border-color:transparent;}
.pay-btn{width:100%;padding:14px;margin-top:10px;border-radius:10px;background:linear-gradient(90deg,#ff9eb5,#e07090);color:#fff;font-weight:900;border:none;cursor:pointer;}
.pay-btn:active{transform:translateY(1px);}
.meta{margin-top:14px;font-size:13px;color:#666;display:flex;justify-content:space-between;flex-wrap:wrap;}
.meta a{color:#ff9eb5;font-weight:700;text-decoration:none;}
.hint{color:#b91c4a;font-weight:700;font-size:13px;min-height:18px;}
</style>
</head>
<body>
<div class="overlay">
<main class="panel">
<header>
<div class="brand">
<div class="logo-mark">S</div>
<div>
<h1>Nail_Sarvnaz — رزرو نوبت</h1>
<p class="lead">زیبایی دستانت آغاز اعتماد به نفس توست</p>
</div>
</div>
<div style="text-align:left;font-size:13px;color:#666;">
📍 میدان گلشهر<br>ساختمان ستاره، طبقه ۳، واحد ۸
</div>
</header>

<form id="bookingForm" autocomplete="on" novalidate>
<div class="row">
<div class="col">
<label for="fullname">نام و نام خانوادگی *</label>
<input id="fullname" name="fullname" type="text" placeholder="مثلاً سروناز محمدی" required />
</div>
<div class="col">
<label for="phone">شماره موبایل *</label>
<input id="phone" name="phone" type="tel" placeholder="09xxxxxxxxx" required />
</div>
</div>

<label for="service">انتخاب خدمت *</label>
<select id="service" name="service" required>
<option value="" disabled selected>یک گزینه انتخاب کنید</option>
<option value="500000" data-duration="120">کاشت ناخن — ۵۰۰,۰۰۰ تومان</option>
<option value="340000" data-duration="120">ترمیم-لمینت — ۳۴۰,۰۰۰ تومان</option>
<option value="180000" data-duration="60">ژلیش دست و پا — ۱۸۰,۰۰۰ تومان</option>
<option value="800000" data-duration="180">دست و پا — ۸۰۰,۰۰۰ تومان</option>
</select>

<label for="datepicker">تاریخ *</label>
<input type="text" id="datepicker" placeholder="انتخاب تاریخ" readonly />

<div class="price-box" id="priceBox">لطفاً خدمت و تاریخ را انتخاب کنید</div>
<div id="timeList" class="times" aria-live="polite" aria-atomic="true"></div>
<div class="hint" id="formHint" aria-live="assertive"></div>

<button type="button" id="payBtn" class="pay-btn">ثبت رزرو و پرداخت ۳۰٪</button>

<div class="meta">
اینستاگرام: <a href="https://instagram.com/nail_sarvnaz" target="_blank" rel="noopener">@nail_sarvnaz</a>
<div>روزهای فرد از ساعت ۱۲ ظهر و روزهای زوج از ساعت ۱ ظهر</div>
</div>
</form>
</main>
</div>

<script>
// ==== تنظیمات ====
const WORK_START_ODD=12*60; // روزهای فرد از ۱۲ ظهر
const WORK_START_EVEN=13*60; // روزهای زوج از ۱۳ ظهر
const LAST_SLOT=17*60; // آخرین تایم رزرو ۵ عصر
const STEP=60; // فاصله هر رزرو یک ساعت
const KEY='nail_reservations_v3';

// ==== توابع کمکی ====
const $el = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const pad2 = n=>String(n).padStart(2,'0');

function formatPersianHour(minutes){
  let h=Math.floor(minutes/60), m=minutes%60;
  const suffix=h>=12?'بعدازظهر':'قبل‌ازظهر';
  let hour=h>12?h-12:h;
  if(hour===0) hour=12;
  const pers=(str)=>str.replace(/\d/g,d=>'۰۱۲۳۴۵۶۷۸۹'[d]);
  return pers(String(hour))+':'+pers(pad2(m))+' '+suffix;
}

function toShamsi(gDate){
  const g_y=gDate.getFullYear(), g_m=gDate.getMonth()+1, g_d=gDate.getDate();
  const g_days_in_month=[31,28,31,30,31,30,31,31,30,31,30,31];
  const j_days_in_month=[31,31,31,31,31,31,30,30,30,30,30,29];
  let gy=g_y-1600, gm=g_m-1, gd=g_d-1;
  let g_day_no=365*gy + Math.floor((gy+3)/4)-Math.floor((gy+99)/100)+Math.floor((gy+399)/400);
  for(let i=0;i<gm;i++) g_day_no+=g_days_in_month[i];
  if(gm>1 && ((gy%4===0 && gy%100!==0) || (gy%400===0))) g_day_no++;
  g_day_no+=gd;
  let j_day_no=g_day_no-79;
  let j_np=Math.floor(j_day_no/12053);
  j_day_no%=12053;
  let jy=979+33*j_np+4*Math.floor(j_day_no/1461);
  j_day_no%=1461;
  if(j_day_no>=366){jy+=Math.floor((j_day_no-1)/365); j_day_no=(j_day_no-1)%365;}
  let jm,jd;
  for(jm=0;jm<11;jm++){if(j_day_no<j_days_in_month[jm]) break; j_day_no-=j_days_in_month[jm];}
  jd=j_day_no+1;
  return `${jy}/${pad2(jm+1)}/${pad2(jd)}`;
}

function loadReservations(){try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){return[];}}
function saveReservations(arr){localStorage.setItem(KEY,JSON.stringify(arr));}

function hasConflict(dateStr,start,duration){
  const reservations=loadReservations();
  const newEnd=start+duration;
  return reservations.some(r=>r.date===dateStr && !(newEnd<=r.start || start>=r.end));
}

// ==== تنظیمات datepicker شمسی ساده ====
const dateInput=$el('#datepicker');
dateInput.addEventListener('focus',()=>{showCalendar();});

function showCalendar(){
  const today=new Date();
  dateInput.value=toShamsi(today);
}

// ==== تولید تایم‌های رزرو ====
function generateSlots(){
  const serviceOpt=$el('#service').selectedOptions[0];
  const date=dateInput.value;
  const container=$el('#timeList');
  container.innerHTML='';
  if(!serviceOpt||!serviceOpt.dataset.duration||!date) return;
  const duration=Number(serviceOpt.dataset.duration);
  const [jy,jm,jd]=date.split('/').map(Number);
  const day=new Date(jy,jm-1,jd).getDate();
  const startWork=(day%2===1)?WORK_START_ODD:WORK_START_EVEN;

  for(let t=startWork; t+duration<=LAST_SLOT; t+=STEP){
    const btn=document.createElement('button');
    btn.type='button'; btn.className='slot'; btn.textContent=formatPersianHour(t);
    if(hasConflict(date,t,duration)){btn.classList.add('taken');btn.disabled=true;}
    else btn.addEventListener('click',()=>{$$('.slot').forEach(s=>s.classList.remove('selected'));btn.classList.add('selected'); container.dataset.selected=String(t);});
    container.appendChild(btn);
  }
}

// ==== پیش‌پرداخت ====
function updatePriceBox(){
  const sel=$el('#service'); const price=sel.value; const box=$el('#priceBox');
  if(!price){box.textContent='لطفاً خدمت و تاریخ را انتخاب کنید'; return;}
  const deposit=Math.round(Number(price)*0.3);
  box.textContent='پیش‌پرداخت: '+deposit.toLocaleString('fa-IR')+' تومان';
}

$el('#service').addEventListener('change',()=>{updatePriceBox(); generateSlots();});
dateInput.addEventListener('change',()=>{generateSlots();});

// ==== ثبت رزرو ====
function validPhone(s){const digits=s.replace(/\D/g,''); return /^9\d{9}$/.test(digits)||/^09\d{9}$/.test(digits);}

$el('#payBtn').addEventListener('click',async()=>{
  const fullname=$el('#fullname').value.trim();
  const phone=$el('#phone').value.trim();
  const serviceEl=$el('#service').selectedOptions[0];
  const date=dateInput.value;
  const selectedStart=$el('#timeList').dataset.selected;

  if(!fullname||!phone){$el('#formHint').textContent='نام و شماره موبایل باید وارد شود.'; return;}
  if(!validPhone(phone)){$el('#formHint').textContent='شماره موبایل معتبر وارد کنید (مثال: 09123456789).'; return;}
  if(!serviceEl||!serviceEl.dataset.duration){$el('#formHint').textContent='لطفاً یک خدمت انتخاب کنید.'; return;}
  if(!date){$el('#formHint').textContent='لطفاً یک تاریخ انتخاب کنید.'; return;}
  if(!selectedStart){$el('#formHint').textContent='لطفاً یک زمان از لیست انتخاب کنید.'; return;}

  const duration=Number(serviceEl.dataset.duration), start=Number(selectedStart);
  const reservation={
    name:fullname, phone:phone, service:serviceEl.textContent, price:serviceEl.value,
    date:date, start:start, end:start+duration,
    code:Math.floor(100000+Math.random()*900000)
  };

  try{
    const response=await fetch('YOUR_GOOGLE_SHEET_WEB_APP_URL',{
      method:'POST',
      body:JSON.stringify(reservation)
    });
    const result=await response.json();
    if(result.status==='success'){
      alert(`نوبت ثبت شد:\n${reservation.service} — ${date} — ${formatPersianHour(reservation.start)}\nپیش‌پرداخت: ${Math.round(Number(serviceEl.value)*0.3).toLocaleString('fa-IR')} تومان\nکد رهگیری: ${reservation.code}`);
      delete $el('#timeList').dataset.selected;
      generateSlots();
    } else {$el('#formHint').textContent='خطا در ثبت رزرو، لطفاً دوباره تلاش کنید.';}
  }catch(err){console.error(err); $el('#formHint').textContent='خطا در اتصال به سرور.';}
});

window.addEventListener('load',()=>{updatePriceBox(); generateSlots();});
</script>
</body>
</html>
